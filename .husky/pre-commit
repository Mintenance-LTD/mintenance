#!/bin/sh
# Husky pre-commit hook
# This runs before every commit to ensure code quality

echo "ğŸ” Running pre-commit checks..."

# Check for existing hex validation
node scripts/ci/check-no-hex.js || exit 1

# Run pre-commit checks script
node scripts/pre-commit-checks.js || exit 1

# Type checking
echo "ğŸ“ Type checking..."
npm run type-check -w @mintenance/web --silent || {
  echo "âŒ TypeScript errors in web app"
  exit 1
}

# Linting staged files
echo "ğŸ”§ Linting staged files..."
npx lint-staged || {
  echo "âŒ Linting failed"
  exit 1
}

# Run unit tests for changed files
echo "ğŸ§ª Running tests for changed files..."
CHANGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(ts|tsx)$' | grep -E '(apps/web|apps/mobile)' || true)

if [ -n "$CHANGED_FILES" ]; then
  # Find related test files
  for file in $CHANGED_FILES; do
    TEST_FILE="${file%.tsx}.test.tsx"
    TEST_FILE="${TEST_FILE%.ts}.test.ts"

    if [ -f "$TEST_FILE" ]; then
      echo "Running tests for $TEST_FILE..."
      npm test -- "$TEST_FILE" --bail --findRelatedTests || {
        echo "âŒ Tests failed for $file"
        exit 1
      }
    fi
  done
fi

# Check for console statements
echo "ğŸ” Checking for console statements..."
npm run audit:console --silent || {
  echo "âš ï¸  Console statements found (will not block commit)"
}

# Check for any types
echo "ğŸ” Checking for 'any' types..."
npm run audit:any-types --silent || {
  echo "âš ï¸  'any' types found (will not block commit)"
}

# Prevent commits to main/master directly
BRANCH=$(git symbolic-ref --short HEAD)
if [ "$BRANCH" = "main" ] || [ "$BRANCH" = "master" ]; then
  echo "âŒ Direct commits to $BRANCH are not allowed!"
  echo "Please create a feature branch and submit a PR."
  exit 1
fi

# Check for large files
echo "ğŸ“¦ Checking file sizes..."
MAX_SIZE=500000 # 500KB
for FILE in $(git diff --cached --name-only); do
  if [ -f "$FILE" ]; then
    SIZE=$(wc -c < "$FILE")
    if [ $SIZE -gt $MAX_SIZE ]; then
      echo "âŒ File $FILE is too large: $(($SIZE / 1024))KB (max: $(($MAX_SIZE / 1024))KB)"
      exit 1
    fi
  fi
done

# Check for sensitive data patterns
echo "ğŸ”’ Checking for sensitive data..."
SENSITIVE_PATTERNS="(password|secret|api_key|private_key|access_token|auth_token)[\s]*=[\s]*['\"][^'\"]+['\"]"

for FILE in $(git diff --cached --name-only | grep -v '.env' | grep -E '\.(ts|tsx|js|jsx)$'); do
  if [ -f "$FILE" ]; then
    if grep -iE "$SENSITIVE_PATTERNS" "$FILE" > /dev/null; then
      echo "âš ï¸  Possible sensitive data in $FILE"
      echo "Please review and use environment variables instead."
      # Don't exit, just warn
    fi
  fi
done

echo "âœ… Pre-commit checks passed!"
